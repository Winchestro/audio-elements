<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-slider/paper-slider.html">
<link rel="import" href="../core-dropdown-menu/core-dropdown-menu.html">
<link rel="import" href="../core-item/core-item.html">

<polymer-element name="audio-context" constructor="AudioContext">
  <template>
    <style>
      :host{
        display:block;
      }
      #canvas{
        border-radius:50%;
        background:black;
      }
    </style>
    <canvas id="canvas" width="{{size}}" height="{{size}}"></canvas>
    <content></content>
  </template>
  <script>Polymer((function static(){
    Object.defineProperty(window,"::sfx::",{
      value:new (window.AudioContext||window.webkitAudioContext)
    });
    const ACCESSORS = {
      $CHILD:{
        get:function(){
          return this.children[0];
        }
      },
    };
    const PROTOTYPE = {
      publish:{
        size:75,
      },
      observe:{
      },
      created:function(){
        const sfx = window["::sfx::"];
        this.node = sfx.destination;
        
      },
      ready:function(){
        
      },
      attached:function(){
        
      },
      detached:function(){
      },
      domReady:function(){
        this.$CHILD.connect(this.node);
        
      },
    };
    Object.defineProperties(PROTOTYPE,ACCESSORS);
    return PROTOTYPE;
  })());
  /*

  */</script>
</polymer-element>

<polymer-element name="audio-node">
  <template>
    <style>
      :host{
        display:block;
      }
      #canvas{
        border-radius: 50%;
        background:yellowgreen;
      }
    </style>
    <canvas id="canvas" width="{{size}}" height="{{size}}"></canvas>
  </template>
  <script>Polymer((function static(){
    const ACCESSORS={
      $SFX:{
        get:function(){
          return window["::sfx::"];
        }
      },
      $CTX:{
        get:function(){
          return this.$.canvas.getContext("2d");
        }
      },
      $INPUTS:{
        get:function(){
          return this.node.numberOfInputs;
        }
      },
      $OUTPUTS:{
        get:function(){
          return this.node.numberOfOutputs;
        }
      },
      _$chanelCount:{
        get:function(){
          return this.node.chanelCount;
        },
        set:function(v){
          this.node.chanelCount=v;
        }
      },
      _$chanelCountMode:{
        get:function(){
          return this.node.chanelCountMode;
        },
        set:function(v){
          this.node.chanelCountMode=v;
        }
      },
      _$chanelInterpretation:{
        get:function(){
          return this.node.chanelInterpretation;
        },
        set:function(v){
          this.node.chanelInterpretation=v;
        }
      }
    };
    const METHODS={
      connect:{
        value:function(target){
          if(this.visualize){
            this.node.connect(this.analyser);
            this.analyser.connect(target);
          }else this.node.connect(target);
          return this;
        }
      },
      disconnect:{
        value:function(){
          this.node.disconnect();
          return this;
        }
      }
    };
    const PROTOTYPE = {
      publish:{
        size:100,
        visualize:false,
        controls:false
      },
      observe:{
      },
      created:function(){
      },
      ready:function(){
        this.startVisualizationLoop();
      },
      domReady:function(){
         
      },
      startVisualizationLoop:function(){
        this.analyser   = this.$SFX.createAnalyser();
        this.analyser.frequencyBinCount = 2048;
        this.timeDomain = new Uint8Array(this.analyser.frequencyBinCount);
        const C = this.$CTX;
        const A = this.analyser;
        const T = this.timeDomain;
        const S = this.size;
        var i,n;
        C.strokeStyle = "white";
        C.lineJoin = "round";
        C.lineWidth = Math.sqrt(S)/5;
        drawLoop();
        function drawLoop(){
          A.getByteTimeDomainData(T);
          C.clearRect(0,0,S,S);
          C.beginPath();
          C.moveTo(-S/25,S/2);
          for(i = 0; i<S; i++){
            n = (T.length / S * i)>>0;
            C.lineTo(i,T[n%T.length]/256*S*.5+S/4);
          }
          C.stroke();
          requestAnimationFrame(drawLoop);
        }
      },
      attached:function(){
      },
      detached:function(){
      }
    };
    Object.defineProperties(PROTOTYPE,ACCESSORS);
    Object.defineProperties(PROTOTYPE,METHODS);
    return PROTOTYPE;
  })());
  /*

  */</script>
</polymer-element>

<polymer-element name="audio-oscillator" constructor="AudioOscillator" extends="audio-node">
  <template>
    <shadow></shadow>
    <paper-slider id="freqInput" pin immediateValue="{{frequency}}" min="1" max="2000"></paper-slider>
    <paper-slider id="detuneInput" pin immediateValue="{{detune}}" min="0" max="500"></paper-slider>
    <core-dropdown-menu selected="{{type}}" valueattr="label">
      <core-item label="sine"></core-item>
      <core-item label="square"></core-item>
      <core-item label="sawtooth"></core-item>
      <core-item label="triangle"></core-item>
    </core-dropdown-menu>
  </template>
  <script>Polymer((function static(){
    const METHODS = {
      start:{
        value:function(){
          this.node.start();
          return this;
        }
      },
      stop:{
        value:function(){
          this.node.stop();
          return this;
        }
      },
      setPeriodicWave:{
        value:function(){
          this.node.setPeriodicWave();
          return this;
        }
      },
    };
    const PROTOTYPE = {
      publish:{
        frequency:3000,
        detune:100,
        type:"sine",

      },
      frequencyChanged:function(oldv,newv){
        this.node.frequency.value = newv;
      },
      detuneChanged:function(oldv,newv){
        this.node.detune.value = newv;
      },
      typeChanged:function(oldv,newv){
        this.node.type = newv;
      },
      observe:{
      },
      created:function(){
        const sfx = window["::sfx::"];
        this.node = sfx.createOscillator();
        this.start();
        
      },
    };
    Object.defineProperties(PROTOTYPE,METHODS);
    return PROTOTYPE;
  })());
  /*

  */</script>
</polymer-element>

